# Handoff ‚Äî Repo `pro` (canon)

Date: 2026-02-22  
Sujet: Agenda ‚ÄúNouvelle session‚Äù ‚Äî mode quick multi-dates + auto-th√©matique biblioth√®que.

## Update 2026-02-27 ‚Äî Quiz formulaires: champ commentaire compact + aide
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_content.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - champ `Commentaire` affich√© en monoligne (`input text`) dans les formulaires quiz cibl√©s.
  - retour √† la ligne forc√© apr√®s `Bonne r√©ponse` (avant le bloc des fausses propositions).
  - positionnement harmonis√©: `Commentaire` plac√© sous les champs `Fausse proposition`.
  - suppression du `mb-2` sous le texte ‚ÄúLes fausses propositions sont essentielles pour la version num√©rique du quiz.‚Äù
  - espacement des boutons de soumission augment√© √† `mt-4` sur les formulaires quiz cibl√©s.
  - ajout d‚Äôune mention d‚Äôaide sous le champ: `√Ä l‚Äôattention du quiz master.`
  - champ conserv√© facultatif (contrat backend inchang√©).
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_content.php` OK

## Update 2026-02-27 ‚Äî Quiz formulaires: propositions regroup√©es, support en dernier
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_content.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - dans les formulaires quiz (biblioth√®que + s√©rie perso), d√©placement du bloc `Type support` (et champs li√©s) en bas de formulaire.
  - regroupement des 3 champs propositions ensemble, juste apr√®s `Commentaire`.
  - harmonisation des labels en `Fausse proposition 1/2/3`.
  - suppression de la proposition 4 dans les formulaires s√©rie perso pour alignement global.
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_content.php` OK

## Update 2026-02-27 ‚Äî Quiz: champ `Commentaire` r√©int√©gr√© dans les formulaires d‚Äô√©dition
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_content.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - ajout du champ `Commentaire` dans les formulaires quiz suivants:
    - cr√©ation de question en s√©rie perso
    - √©dition de question en s√©rie perso
    - cr√©ation d‚Äôune question de remplacement (lot temporaire, contexte session client)
    - modification d‚Äôune question existante (lot temporaire, contexte admin biblioth√®que)
  - pr√©remplissage du commentaire existant en modes √©dition.
  - aucun changement backend requis: validation/persistance `commentaire` d√©j√† en place.
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_content.php` OK

## Update 2026-02-27 ‚Äî Biblioth√®que: `A la une` / `En ce moment` en mode strict ‚Äúen cours‚Äù
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - tri `A la une` (`preset=now`, type `cotton`) recal√© sur une fen√™tre stricte:
    - `today >= jour_associe_debut`
    - `today <= jour_associe_fin`
  - badge `En ce moment` align√© sur la m√™me r√®gle stricte (suppression de la tol√©rance ‚ÄúJ-90‚Äù).
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php` OK

## Update 2026-02-27 ‚Äî Fix √©dition meta admin: pr√©servation du r√©f√©rencement Cotton/Communaut√©
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/editor/p_theme_save.php`
  - `pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_edit.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Constat:
  - une √©dition meta admin sur une s√©rie Cotton/Communaut√© pouvait faire passer `community_items.status='hidden'`, retirant la s√©rie de la liste.
- Actions r√©alis√©es:
  - `p_theme_save.php`: les champs de partage communaut√© ne sont plus inject√©s en update lorsque l‚Äô√©diteur n‚Äôest pas l‚Äôauteur.
  - `t_theme_edit.php`: case de partage affich√©e uniquement √† l‚Äôauteur.
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/editor/p_theme_save.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/editor/t_theme_edit.php` OK

## Update 2026-02-27 ‚Äî Admin: bypass lock ‚Äúen cours d‚Äôutilisation‚Äù sur √©dition/suppression
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - backend:
    - `clib_content_edit_or_delete_allowed(...)` autorise d√©sormais le compte admin (`id_client=10`) √† modifier/supprimer une th√©matique m√™me si elle est utilis√©e dans des sessions en cours/√† venir.
    - ajout de logs d√©di√©s de bypass admin: `CONTENT_EDIT_ADMIN_BYPASS_IN_USE` / `CONTENT_DELETE_ADMIN_BYPASS_IN_USE`.
  - view:
    - bandeau ‚Äúen cours d‚Äôutilisation‚Äù conserv√©.
    - verrou UI lev√© uniquement pour admin (`$is_theme_mutation_locked=false` c√¥t√© admin), afin de garder les actions visibles et actives.
    - non-admin inchang√© (verrou maintenu).
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK

## Update 2026-02-27 ‚Äî Biblioth√®que quiz: usage list `temp_lots` corrig√© (`T` vs `L`)
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - extension de `clib_usage_get(...)` avec un mode token quiz explicite (`L|T`, d√©faut `L`).
  - en mode `T`:
    - filtre strict `id_type_produit=5`
    - match uniquement via `FIND_IN_SET('T{id}', lot_ids)`
    - exclusion des matches `id_produit`/`community_items` pour √©viter les collisions d‚ÄôID num√©riques avec les lots catalogue.
  - la list biblioth√®que appelle d√©sormais `clib_usage_get(..., 'T')` sur l‚Äôonglet admin `Lots temporaires`.
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php` OK

## Update 2026-02-27 ‚Äî Biblioth√®que list: pagination mobile responsive
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - ajout d‚Äôun scope CSS pagination d√©di√© (`clib-pagination-wrap`, `clib-pagination`) dans la page list biblioth√®que.
  - en mobile (`max-width:575.98px`), le bloc pagination passe en scroll horizontal (`overflow-x:auto`) pour √©viter le d√©bordement.
  - en desktop, pagination conserv√©e centr√©e avec retour √† la ligne possible.
- V√©rification:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php` OK

## Update 2026-02-27 ‚Äî Quiz `A la une`: th√©matiques du moment + badge `En ce moment`
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - alignement Quiz avec les playlists en `preset=now` (`A la une`, onglet `Cotton`):
    - priorit√© SQL sur la fen√™tre date `jour_associe_debut/fin` (au lieu de la r√®gle legacy `flag_une`).
    - chargement des champs `jour_associe_debut/fin` aussi pour Quiz en list.
  - activation du badge `En ce moment` sur les s√©ries Quiz avec la m√™me r√®gle date que les playlists.
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php` OK

## Update 2026-02-27 ‚Äî Badge `Populaire`: exclusion des lots temporaires `T`
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - ajout d‚Äôune garde `type !== 'temp_lots'` sur le calcul et l‚Äôaffichage du badge `Populaire` dans la list biblioth√®que.
  - effet: pas de badge `Populaire` sur les cards de lots temporaires admin; badge conserv√© pour les contenus catalogue (`Cotton`/`Communaut√©`/`Mes`).
- V√©rification:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php` OK

## Update 2026-02-27 ‚Äî CTA admin lot temporaire: d√©mo mono-lot (sans duplication de session)
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_script.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - CTA `Lancer une d√©mo` (vue admin lot temporaire) rerout√© vers `ec_bibliotheque_script.php` (`mode=content_library_temp_lot_demo`) au lieu de `session_duplicate`.
  - nouveau backend d√©di√©:
    - `session_init` d√©mo quiz
    - puis `session_theme` avec `id_catalogue_produit='T{id}'` (lot temporaire courant uniquement)
  - r√©sultat: la d√©mo cr√©√©e ne reprend plus la session li√©e compl√®te; elle contient uniquement la s√©rie du lot temporaire consult√©.
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_script.php` OK

## Update 2026-02-27 ‚Äî Lots temporaires admin: suppression du badge ‚Äúen cours d‚Äôutilisation‚Äù
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - neutralisation du lock d‚Äôusage sur la vue lot temporaire (`$is_temp_lot_view`), pour ne plus afficher le badge:
    - `Cette s√©rie est en cours d‚Äôutilisation...`
    - `Modification et suppression temporairement impossible.`
  - changement limit√© au contexte lot temporaire, sans impact sur les s√©ries/playlists standards.
- V√©rification:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK

## Update 2026-02-27 ‚Äî Onglet admin `Lots temporaires`: tri d√©croissant par r√©cence
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - ajustement du tri de `clib_quiz_temp_lots_admin_list_get(...)` pour afficher les lots du plus r√©cent au plus ancien.
  - ordre SQL appliqu√©: `ORDER BY t.date_ajout DESC, t.id DESC` (au lieu de `session_date DESC`).
- V√©rification:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php` OK

## Update 2026-02-27 ‚Äî Modale admin lot temporaire: URL support question affich√©e
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - dans le bloc `Support(s) actuel(s)` (modale √©dition admin), le lien `Support question` affiche d√©sormais l‚ÄôURL compl√®te:
    - rendu: `Support question : {url cliquable}`
- V√©rification:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK

## Update 2026-02-27 ‚Äî Quiz lot temporaire (admin): masquage proposition 4 en √©dition
- Scope code:
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - retrait du champ `Prop. 4` (`name="proposition_4"`) dans le formulaire d‚Äô√©dition admin de question (lot temporaire / contexte biblioth√®que)
  - objectif: alignement UI avec le flux de remplacement existant (3 fausses propositions affich√©es)
- V√©rifications:
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK

## Update 2026-02-25 ‚Äî Fix responsive home INS/CSO quand la sidebar est visible
- Scope code:
  - `pro/web/ec/modules/communication/home/ec_home_index.php`
  - `pro/web/ec/includes/css/ec_custom.css`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_abonnement.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_abonnement_cso.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_evenement.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_particulier.php`
  - `pro/web/ec/modules/widget/ec_widget_jeux_discover_library.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - ajout d‚Äôun scope explicite ‚Äúhome no-offer INS/CSO‚Äù avec classe de contexte sur la `row`:
    - `home-ins-cso-nooffer-grid`
  - ajout d‚Äôun marquage de r√¥le par widget dans ce scope:
    - `home-nooffer-widget-offer`
    - `home-nooffer-widget-library`
  - ajout de r√®gles CSS desktop `>=992px` sur le scope INS/CSO no-offer:
    - ratio `2/3 - 1/3` appliqu√© m√™me sans classe body `sidebar-*` (fix desktop moyen)
    - renfort conserv√© en √©tats sidebar (`sidebar-menu`, `sidebar-icons`, `sidebar-compact`)
    - widget offre forc√© √† `66.666%` (2/3)
    - widget library forc√© √† `33.333%` (1/3)
  - extension du marquage `offer` au widget particulier
  - mise √† jour du visuel widget library:
    - remplacement de la banni√®re par `cotton-media-kit-portail.jpg`
    - mobile align√© au rendu desktop (visuel unique plein largeur, sans scroll horizontal)
  - aucune modification du comportement hors scope (autres homes/profils inchang√©s)
- V√©rifications:
  - `php -l` OK:
    - `ec_home_index.php`
    - `ec_widget_ecommerce_abonnement.php`
    - `ec_widget_ecommerce_abonnement_cso.php`
    - `ec_widget_ecommerce_evenement.php`
    - `ec_widget_ecommerce_particulier.php`
    - `ec_widget_jeux_discover_library.php`

## Update 2026-02-24 ‚Äî Stepper mobile-first tunnel agenda (Option A)
- Scope code:
  - `pro/web/ec/modules/tunnel/start/ec_start_include_header.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_include_stepper.php` (nouveau)
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_script.php`
- Scope doc:
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - ajout d‚Äôun composant stepper compact r√©utilisable (Option A):
    - ligne `√âtape X/5 ‚Äî {libell√©}`
    - mini barre de progression
    - non cliquable
  - int√©gration centralis√©e dans le header start:
    - mobile: stepper au-dessus du titre
    - desktop: stepper inline √† gauche du titre
  - mapping appliqu√©:
    - step 1 `Jeu`: `start/game/choose/*?from=agenda&mode=quick`
    - step 2 `Contenu`: `start/agenda/mode/*`
    - step 3 `Param√®tres`: `start/game/setting/*` en quick agenda + flow biblioth√®que agenda
    - step 4 `R√©cap`: `start/game/resume/*` et `start/game/resume-batch/*`
    - step 5 `C‚Äôest pr√™t !`: `start/game/view/*`
  - couleur du stepper:
    - barre remplie branch√©e sur les classes couleur jeu existantes `bg-color-{seo_slug_jeu}`
    - aucun hardcode de palette sp√©cifique stepper
  - pont biblioth√®que th√©matique (agenda):
    - pivot `agenda/mode` -> biblioth√®que enrichi avec `from=agenda&mode=library`
    - conservation du contexte dans les URLs list/view
    - affichage stepper `√âtape 2/5 ‚Äî Contenu` sur list + view seulement dans ce contexte
    - redirection biblioth√®que -> setting enrichie avec `tunnel=agenda` pour conserver l‚Äô√©tape 3
- V√©rifications:
  - `php -l` OK:
    - `ec_start_include_header.php`
    - `ec_start_include_stepper.php`
    - `ec_start_script.php`
    - `ec_bibliotheque_list.php`
    - `ec_bibliotheque_view.php`
    - `ec_bibliotheque_script.php`
- Point d‚Äôattention:
  - le stepper affiche `4/5 R√©cap` sur `resume` et `5/5 C‚Äôest pr√™t !` sur `view`; en quick batch, l‚Äô√©cran final reste `resume-batch` (pas de page `view` unique).

## Update 2026-02-23 ‚Äî Biblioth√®que: view read-only lot temporaire `T{id}`
- Scope code:
  - `pro/web/.htaccess`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Actions r√©alis√©es:
  - ajout route explicite:
    - `/extranet/games/library/temp/T{id}` -> `ec_bibliotheque_view.php` (token transport√©)
  - `ec_bibliotheque_view.php` √©tendu avec un mode `lot temporaire`:
    - validation token (`^T\\d+$`) + fallback `id` num√©rique
    - chargement `questions_lots_temp` (`id`, `nom`, `descriptif_court`, `question_ids`, `date_ajout`)
    - parsing `question_ids` JSON puis r√©cup√©ration des questions `questions.id` en ordre strict via `ORDER BY FIELD(...)`
    - rendu sur la m√™me page view biblioth√®que (m√™mes blocs/styles/classes), avec libell√©s:
      - titre: `S√©rie auto-g√©n√©r√©e ‚Äî {nom}`
      - identifiant: `T{id}`
      - m√©ta date d‚Äôajout
    - mode read-only strict:
      - actions modifier/supprimer/usage masqu√©es
      - aucun write DB
  - int√©gration qualit√© de vie:
    - depuis la fiche session quiz, les s√©ries `T{id}` ont d√©sormais un lien `Voir le d√©tail` vers la route temp
    - helper URL session->biblioth√®que √©tendu (`item_type=quiz_temp_lot`)
  - s√©curit√© d‚Äôacc√®s:
    - lot temp introuvable -> alerte UI coh√©rente
    - acc√®s direct hors contexte session restreint (admin `id_client=10`)
- V√©rifications:
  - `php -l` OK:
    - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
    - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
- Tests manuels √† ex√©cuter:
  - cr√©er une session quiz papier auto (`lot_ids` avec `T,T,T,L`)
  - depuis la fiche session, cliquer `Voir le d√©tail` sur un lot `T`:
    - v√©rifier rendu align√© avec la view biblioth√®que standard
    - v√©rifier ordre des questions identique au JSON `question_ids`
    - v√©rifier absence d‚Äôactions d‚Äô√©dition/suppression/reorder
  - v√©rifier qu‚Äôun lot temp inexistant affiche bien l‚Äôalerte ‚Äúintrouvable‚Äù

## Update 2026-02-23 ‚Äî Quiz auto papier `T,T,T,L` (pickers V2 + compat Pro)
- Scope code:
  - `global/web/app/modules/jeux/cotton_quiz/app_cotton_quiz_functions.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_list_bloc.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_script.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
  - `documentation/canon/repos/pro/README.md`
- Actions r√©alis√©es:
  - ajout d‚Äôun module V2 de g√©n√©ration quiz papier (sans toucher √† la g√©n√©ration V1 legacy):
    - helpers token `L/T` (`normalize/parse`)
    - contexte partag√© (`excluded_ids`, `question20_used`, `client_id`, `session_date`)
    - 3 builders 6 questions ordonn√©es:
      - `qz_build_temp_history`
      - `qz_build_temp_arts`
      - `qz_build_temp_sciences`
    - persistance lots temporaires via `questions_lots_temp` avec retour token `T{id}` (`qz_create_temp_lot`)
    - orchestrateur `qz_build_paper_auto_lot_ids_csv(...)` avec idempotence si `lot_ids` contient d√©j√† `T`
  - branchement agenda quick:
    - uniquement pour `game=quiz` + mode papier (`flag_controle_numerique=0`)
    - production `lot_ids` final: `T,T,T,L`
    - num√©rique et autres jeux inchang√©s
  - application session s√©curis√©e:
    - validation stricte du CSV lot tokens (`[LT]?\\d+`)
    - normalisation nombre nu -> `L{id}`
  - compat UI Pro avec tokens `T`:
    - fiche session quiz V2: parsing `T/L`, affichage d‚Äôun libell√© ‚ÄúTemporaire‚Äù, d√©tail lot `T` si disponible
    - liste sessions: affichage des noms de lots `T` (fallback `TEMP #id`)
    - suppression de slot quiz: support `T` sans crash
    - biblioth√®que en contexte session quiz: parsing lot_ids compatible `T`
  - logs ajout√©s:
    - `QUIZ_PAPER_AUTO_TEMP_BUILD_START/OK/ERR`
    - `QUIZ_PAPER_AUTO_TEMP_PERSIST_OK/ERR`
    - `QUIZ_PAPER_AUTO_APPLY_OK/ERR`
- V√©rifications:
  - `php -l` OK sur tous les fichiers PHP touch√©s (pro + global)
- Notes:
  - purge `questions_lots_temp` non impl√©ment√©e dans ce patch (TODO trac√©)
  - audit exhaustif UX `T` sur toutes les surfaces Pro √† compl√©ter (TODO trac√©)

## Update 2026-02-23 ‚Äî Stabilisation finale widgets home EC (INS/CSO + liens commande)
- Scope code:
  - `pro/web/ec/modules/communication/home/ec_home_index.php`
  - `pro/web/ec/ec.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_abonnement_cso.php`
  - `pro/web/ec/modules/widget/ec_widget_jeux_discover_library.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
  - `documentation/canon/repos/pro/home_widgets_ins_cso.md`
- Actions r√©alis√©es:
  - correction du bug CTA widgets commande -> `/extranet/dashboard`:
    - cause: closure home no-offer sans capture de `$url_ecommerce`
    - fix: `use (..., $url_ecommerce, ...)` dans `ec_home_index.php`
  - correction URL doublonn√©e `extranet/extranet`:
    - URLs commande pass√©es en root-relative dans `ec.php`
    - suffixes conserv√©s:
      - abonnement: `/extranet/ecommerce/offers/abonnement/s1/1`
      - √©v√©nement: `/extranet/ecommerce/offers/evenement/s1/6`
      - particulier: `/extranet/ecommerce/offers/particulier/s1/1`
  - widget CSO:
    - CTA fix√© explicitement sur `/extranet/ecommerce/offers/abonnement/s1/1`
    - suppression de la note `L'essai gratuit est r√©serv√© aux nouveaux clients.`
  - widget d√©couverte (final):
    - titre `Les jeux Cotton`
    - sous-titre `Parcours les catalogues Blind Test, Bingo Musical et Cotton Quiz.`
    - CTA fixe `D√©couvrir les jeux`
    - bulle ic√¥nes:
      - sombre uniquement pour typologie √©v√©nement (2/3)
      - blanche sinon
    - carte cliquable globalement (`stretched-link`)
    - alignement vertical des bullets centr√© texte/icone
- V√©rifications:
  - `php -l` OK sur les fichiers touch√©s

## Update 2026-02-23 ‚Äî PATCH UI home INS/CSO (discover + CSO offer refonte)
- Scope code:
  - `pro/web/ec/modules/communication/home/ec_home_index.php`
  - `pro/web/ec/modules/widget/ec_widget_jeux_discover_library.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_abonnement_cso.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
  - `documentation/canon/repos/pro/home_widgets_ins_cso.md` (nouveau)
- Actions r√©alis√©es:
  - home no-offer:
    - ajout d‚Äôun ordonnancement par pipeline:
      - INS: d√©couverte puis offre
      - CSO (et autres non-INS): offre puis d√©couverte
  - widget d√©couverte:
    - titre dynamique:
      - INS: `D√âCOUVRE LES JEUX`
      - CSO: `RED√âCOUVRE LES JEUX`
    - CTA dynamique:
      - INS: `D√©couvrir les jeux`
      - CSO: `Red√©couvrir les jeux`
    - header transform√© en banni√®re 3 visuels jeux:
      - `ec/images/communication/actualites/cotton-blind-test-display.jpg`
      - `ec/images/communication/statique/visuel-jeu-bingo-musical.jpg`
      - `ec/images/communication/statique/visuel-jeu-cotton-quiz.jpg`
    - bullets remplac√©es selon brief + pictos en cercle plein color√© par typologie (20/22/21)
  - widget CSO ‚ÄúChoisir une offre‚Äù:
    - suppression de la pastille `Reprise d'abonnement`
    - reprise du layout et remplacement des textes:
      - titre: `‚ú® Fid√©lise ta client√®le et apporte de la nouveaut√©.`
      - intro + 3 bullets (sans engagement / sessions illimit√©es / pr√™t en 2 minutes)
      - CTA: `üöÄ Je choisis mon offre`
      - note bas de carte conserv√©e: `L'essai gratuit est r√©serv√© aux nouveaux clients.`
- V√©rifications:
  - `php -l` OK sur les 3 fichiers modifi√©s

## Update 2026-02-23 ‚Äî PATCH UX INS/CSO CHR (home widget + offers labels)
- Scope code:
  - `pro/web/ec/modules/communication/home/ec_home_index.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_abonnement_cso.php` (nouveau)
  - `global/web/app/modules/ecommerce/widget/app_ecommerce_bloc_offre_tarifaire_abn.php`
- Scope doc:
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
  - `documentation/canon/repos/pro/ecommerce_ins_cso.md` (nouveau)
- Actions r√©alis√©es:
  - audit INS/CSO:
    - source de v√©rit√© = pipeline client (`clients.id_pipeline_etat`) r√©solu vers un nom via `referentiels_clients_pipeline_etats.nom`
    - preuve code:
      - lecture nom pipeline c√¥t√© EC: `pro/web/ec/ec.php:60`
      - fonction source: `global/web/app/modules/entites/clients/app_clients_functions.php:676`
      - SQL: `SELECT nom FROM referentiels_clients_pipeline_etats WHERE id = ...`
  - home widget (segment CHR):
    - cas `offre_client_active_count==0` + typologie CHR + pipeline `CSO` -> widget de r√©activation (sans wording essai)
    - CTA vers la page offers CHR via `$url_ecommerce`
    - `INS` conserve le widget essai existant
    - non-CHR inchang√©
  - page offers ABN:
    - CTA conditionn√© sur segment CHR + pipeline:
      - `INS` => `Essayer gratuitement`
      - `CSO` => `S'abonner`
    - ajout note contextuelle CSO:
      - `L'essai gratuit est r√©serv√© aux nouveaux clients.`
    - non-CHR inchang√©
- Hors scope confirm√©:
  - aucun changement appliqu√© au tunnel Stripe / confirmation (`ec_offres_script.php` non modifi√©)

## Update 2026-02-23 ‚Äî Programmation rapide: toggle r√©currence + aper√ßu commun
- Scope code:
  - `pro/web/ec/modules/tunnel/start/ec_start_step_2_setting.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
- Actions r√©alis√©es:
  - step2 quick:
    - remplacement du toggle initial par un segmented control ‚Äúchips‚Äù lisible:
      - `Dates libres` / `R√©currence`
      - actif: fond violet + texte blanc
      - inactif: fond blanc + border violet + texte violet
      - pilotage via hidden `schedule_mode`
    - repositionnement de la zone date/heure apr√®s les param√®tres jeu (la section `Version du jeu`, quand pr√©sente, passe avant la programmation)
    - mode `Dates libres`: conservation du multi-lignes existant (add/remove) avec adaptation des noms de champs frontend (`free_session_dates[]`, `free_session_times[]`)
    - mode `R√©currence`: fr√©quence `weekly|biweekly|monthly`, r√®gle mensuelle (`nth_weekday` / `last_weekday`), date de fin, horaires multiples (add/remove)
      - champs r√©currence post√©s explicitement (`name=` sur fr√©quence/jour/jusqu'au/r√®gles mensuelles)
      - reconstruction serveur des occurrences (weekly/biweekly/monthly) dans `session_setting_multi`
      - application des exclusions (`excluded_occurrences`) c√¥t√© serveur
      - correction du bug de cr√©ation partielle (cas observ√©: seule la 1re session cr√©√©e)
    - finitions UI retours (it√©ration compl√©mentaire):
      - chips `Dates libres` / `R√©currence` forc√©s sous le label `Programmation`
      - suppression du titre `Dates et heures` en mode `Dates libres`
      - suppression du titre `Horaires` en mode `R√©currence`
      - texte aide `Dates libres` ajust√©:
        - `Ajoute tes sessions une par une, elles seront cr√©√©es dans l'ordre chronologique.`
      - labels ajust√©s:
        - `Heure de session` (mode dates libres)
        - `Heure(s) de session(s) (Appliqu√©e(s) √† toutes les dates.)` (mode r√©currence)
      - microcopies ajout√©es:
        - suppression de `Chaque horaire ajoute une session √† chaque occurrence.`
      - bouton renomm√©:
        - `+` (dates libres)
        - `+` (r√©currence horaires)
      - ajout horaire r√©currence:
        - chaque nouvel horaire est pr√©rempli √† `+1h` du dernier horaire existant
      - rendu r√©currence:
        - titre horaire affich√© une seule fois (non dupliqu√© sur les lignes ajout√©es)
        - bouton suppression horaire centr√© verticalement sur sa ligne
      - uniformisation des champs r√©currence (hauteurs/alignements desktop-mobile)
  - aper√ßu/confirmation commun:
    - compteur avec pluralisation corrig√©e:
      - `1 session sera cr√©√©e`
      - `X sessions seront cr√©√©es`
    - mode `Dates libres`:
      - bloc aper√ßu masqu√© (redondant avec la zone de saisie)
    - mode `R√©currence`:
      - bloc aper√ßu conserv√©
      - suppression d‚Äôoccurrence au cas par cas r√©activ√©e dans la preview (`‚úï`)
    - exclusions stock√©es en hidden `excluded_occurrences` (JSON)
    - payload submit normalis√© en hidden `session_dates[]` / `session_times[]` pour r√©utiliser `frm_mode=session_setting_multi`
    - limite douce 40: warning + case de confirmation obligatoire au-del√†
    - badge compteur redimensionn√© (lisible, non surdimensionn√©)
  - backend `session_setting_multi` renforc√©:
    - validation longueurs identiques `session_dates[]` / `session_times[]`
    - validation format date/heure, d√©doublonnage et tri (via normalisation existante)
    - garde-fou hard limit `200` occurrences (refus serveur explicite)
  - logs structur√©s:
    - `AGENDA_QUICK_PREVIEW_BUILD` (depuis m√©tadonn√©es preview soumises)
    - `AGENDA_QUICK_OCCURRENCE_REMOVE` (depuis exclusions soumises)
    - `AGENDA_QUICK_SUBMIT` (mode, count, over_soft_limit)
- V√©rifications:
  - `php -l pro/web/ec/modules/tunnel/start/ec_start_step_2_setting.php` OK
  - `php -l pro/web/ec/modules/tunnel/start/ec_start_script.php` OK

## Update 2026-02-23 ‚Äî Finitions UX (step2 quick + fiche session + lib view apply)
- Scope code:
  - `pro/web/ec/modules/tunnel/start/ec_start_include_header.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_step_2_setting.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Actions r√©alis√©es:
  - start step 2 agenda quick:
    - titre header quick pass√© √† `Param√®tres des sessions`
    - gestion multi-dates: suppression de ligne disponible, avec au moins une ligne obligatoire
    - bouton suppression ligne date/heure harmonis√© avec `+ Ajouter une date`
    - bouton suppression ligne masqu√© si une seule ligne reste
  - fiche session agenda:
    - `Voir le d√©tail` harmonis√© responsive:
      - desktop inline √† c√¥t√© du titre
      - mobile sous le titre (dans le m√™me bloc)
    - boutons de modif harmonis√©s:
      - mobile `Modifier`
      - desktop `Modifier la playlist` / `Modifier cette s√©rie`
    - quiz s√©ries:
      - suppression unitaire avec modale de confirmation
      - bouton suppression visible seulement si >1 s√©rie
      - suppression de la derni√®re s√©rie => suppression de la session quiz
  - biblioth√®que view (contexte remplacement session):
    - CTA `Appliquer √† cette session` -> `Remplacer`
    - aide texte -> `Choisir cette playlist/s√©rie en remplacement dans ma session`
- V√©rifications:
  - `php -l` OK sur les fichiers modifi√©s

## Update 2026-02-23 ‚Äî Biblioth√®que contexte session (nav_ctx) + Quiz slot-by-slot
- Scope code:
  - `pro/web/ec/ec.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_script.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_list_bloc.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
- Actions r√©alis√©es:
  - biblioth√®que:
    - contexte explicite URL requis: conservation `id_securite_session` uniquement si `nav_ctx=agenda`
    - auto-purge s√©curit√©: si `id_securite_session` est pr√©sent sans `nav_ctx`, purge imm√©diate du contexte serveur (`$_SESSION['library_session_ctx']`)
    - propagation `nav_ctx=agenda` sur URLs de navigation (liste/view, filtres, pagination, retours) quand le contexte session est actif
    - purge forc√©e depuis le menu `Les jeux`: liens menu enrichis avec `clear_session_ctx=1` (+ purge client `localStorage/sessionStorage` best-effort)
    - menu actif contextualis√©:
      - `nav_ctx=agenda` => menu `Mon agenda` actif
      - for√ßage explicite ajout√© aussi sur la biblioth√®que en `context=session` + `id_securite_session` (visu/modif th√©matique en contexte session)
      - sans `nav_ctx` => comportement standard biblioth√®que
    - bandeau optionnel `Contexte session actif` retir√© (liste/view) pour all√©ger l‚ÄôUI
  - Quiz (modification depuis fiche session):
    - ajout `slot_index` sur les liens `Modifier cette s√©rie`
    - application backend ‚Äúslot par slot‚Äù dans `content_library_apply_session_theme` (remplace uniquement le slot cibl√©)
  - Quiz (fiche session):
    - ajout bouton `‚úï` rouge ‚ÄúSupprimer cette s√©rie‚Äù √† c√¥t√© de `Modifier cette s√©rie`
    - nouveau mode script `session_quiz_slot_delete` (suppression unitaire + compactage de `lot_ids`)
  - suppression session Quiz:
    - robustesse restauration du CTA ‚ÄúSupprimer la session‚Äù en cas de d√©tail session quiz partiel (`phase_courante` absent => phase 0)
  - correction flux pivot -> biblioth√®que:
    - `Choisir une th√©matique` ne transporte plus `id_securite_session` (√©vite le faux contexte ‚Äúchanger une th√©matique‚Äù)
  - fiche session agenda -> biblioth√®que:
    - ajout explicite `nav_ctx=agenda` sur les liens sortants (liste + d√©tail th√©matique)
- V√©rifications:
  - `php -l` OK sur tous les fichiers touch√©s

## Update 2026-02-22 ‚Äî Micro-ajustements UX/copies (pivot + biblioth√®que + start step jeu)
- Scope code:
  - `pro/web/ec/modules/tunnel/start/ec_start_agenda_mode.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_include_header.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_step_1_game.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_lib.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
- Actions r√©alis√©es:
  - pivot `start/agenda/mode`:
    - titre page dynamique par jeu (`Nouvelle(s) session(s) de ...`)
    - CTA des 2 blocs en couleur du jeu choisi
    - textes de blocs clarifi√©s:
      - `Programmation rapide : une ou plusieurs sessions`
      - `Choisir une th√©matique : une session √† la fois`
    - descriptions blocs adapt√©es au jeu (quiz: s√©ries / bingo-blind: playlists)
  - flux pivot -> biblioth√®que (`Choisir une th√©matique`):
    - suppression du transport `id_securite_session` (plus de faux contexte session)
    - suppression de la session pr√©-initialis√©e si encore vide/incompl√®te (anti session fant√¥me)
  - start choix jeu:
    - titre: `Je programme mes sessions de jeu`
    - CTA cartes: `Cr√©er mes jeux`
  - biblioth√®que:
    - ajout d‚Äôun helper commun pour lien de retour session:
      - `clib_session_back_url_if_owned_get`
      - `clib_session_back_link_html_get`
    - bandeaux contextuels `context=session` (view + list) enrichis avec lien inline:
      - `‚Äî Retour √† la session`
    - lien affich√© uniquement si session valide et appartenant au client courant
- V√©rifications:
  - `php -l` OK sur tous les fichiers touch√©s

## Update 2026-02-22 ‚Äî Pivot d√©plac√©e apr√®s step 1 + harmonisation d√©tail contenu
- Scope code:
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_agenda_mode.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_include_header.php`
  - `pro/web/ec/ec.php`
  - `pro/web/ec/modules/widget/ec_widget_jeux_sessions_cta.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_offre_client_bloc.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_step_0_offres_client.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
- Actions r√©alis√©es:
  - flux agenda ‚ÄúNouvelle session‚Äù rerout√© vers `step_1_game` en premier:
    - CTA agenda -> `start/game/choose/*?from=agenda&mode=quick`
    - en multi-offres -> `start/game/offres/0?from=agenda&mode=quick`
  - pivot de programmation d√©plac√©e apr√®s s√©lection du jeu:
    - apr√®s `session_init` en quick mode, redirection vers `start/agenda/mode/{id_offre}` avec `id_securite_session` + `seo_slug_jeu`
    - fallback direct sur la pivot: message ‚ÄúChoisis d‚Äôabord un jeu‚Äù + bouton retour step 1
  - pivot UI mise √† jour (Variante A):
    - titre `Nouvelle session`
    - sous-titre `Comment veux-tu programmer tes prochaines sessions ?`
    - 2 cards avec images locales:
      - `prog_rapide.jpg` -> CTA `Programmer par date(s)`
      - `prog_choisir_thematique.jpg` -> CTA `Choisir une th√©matique`
  - `agenda_mode_select` renforc√©:
    - contexte post-step1: quick -> `step_2_setting` multi-dates ; library -> biblioth√®que filtr√©e jeu + session
    - fallback legacy conserv√© si pas de session/jeu
  - fiche session (agenda view) align√©e:
    - liens `Voir le d√©tail` conserv√©s √† c√¥t√© du nom playlist/s√©rie
    - bouton de modification maintenu √† droite
    - Blindtest/Bingo: sous-titre + d√©tail playlist internes masqu√©s (d√©tail via biblioth√®que VIEW)
- V√©rifications:
  - `php -l` OK:
    - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
    - `pro/web/ec/modules/tunnel/start/ec_start_agenda_mode.php`
    - `pro/web/ec/modules/tunnel/start/ec_start_include_header.php`
    - `pro/web/ec/ec.php`
    - `pro/web/ec/modules/widget/ec_widget_jeux_sessions_cta.php`
    - `pro/web/ec/modules/widget/ec_widget_ecommerce_offre_client_bloc.php`
    - `pro/web/ec/modules/tunnel/start/ec_start_step_0_offres_client.php`
    - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`

## Update 2026-02-22 ‚Äî Agenda mode, multi-dates, auto-th√®me, changement de th√®me
- Scope code:
  - `pro/web/.htaccess`
  - `pro/web/ec/ec.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_agenda_mode.php` (nouveau)
  - `pro/web/ec/modules/tunnel/start/ec_start_step_1_game.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_step_2_setting.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_step_4_resume_batch.php` (nouveau)
  - `pro/web/ec/modules/tunnel/start/ec_start_include_header.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_list_bloc.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_script.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
  - `pro/web/ec/modules/widget/ec_widget_jeux_sessions_cta.php`
- Actions r√©alis√©es:
  - nouveau point d‚Äôentr√©e agenda:
    - `/extranet/start/agenda/mode/{id_offre}` avec 2 choix:
      - A: programmer par date(s) + th√©matiques auto
      - B: choisir une th√©matique avant (biblioth√®que)
  - mode quick:
    - propagation du contexte `from=agenda&mode=quick`
    - step 2 multi-dates (ajout/suppression de lignes date+heure)
    - nouveau `frm_mode=session_setting_multi`:
      - cr√©ation N sessions (1/date)
      - application settings sur chaque session
      - attribution auto-th√©matique Cotton, puis `session_theme`
      - r√©sum√© batch `/extranet/start/game/resume-batch/{batch_token}`
  - auto-th√©matique:
    - ranking r√©utilis√© depuis la biblioth√®que (`clib_list_get(..., preset='themes')`)
    - stats popularit√© r√©utilis√©es (`clib_popularity_stats_for_items_get`)
    - anti-r√©p√©tition par jeu (365j), fallback 180/30/0, anti-doublon intra-lot ‚Äúsi possible‚Äù
    - logs: `AGENDA_QUICK_CREATE_BATCH`, `AGENDA_QUICK_THEME_PICK`, `AGENDA_QUICK_CREATE_DONE`
  - changement de th√©matique sur session existante:
    - CTA ‚ÄúChanger la th√©matique‚Äù conserv√© sur la fiche d√©tail session (retir√© des cartes agenda)
    - biblioth√®que appel√©e avec `id_securite_session`, atterrissage sur la liste filtr√©e jeu
    - bandeau jaune ‚ÄúModification de th√©matique‚Äù affich√© en biblioth√®que (liste + fiche)
    - mode `content_library_apply_session_theme` pour appliquer `session_theme` sans recr√©er de session
- V√©rifications:
  - `php -l` OK sur tous les fichiers PHP modifi√©s
- Points d‚Äôattention:
  - marqueur `auto_theme=1` port√© dans les logs structur√©s + batch session store (pas de colonne DB d√©di√©e ajout√©e)
  - pour le flux ‚Äúchanger th√©matique‚Äù, l‚Äôapplication se fait depuis la biblioth√®que (s√©lection explicite) sur la session existante
  - quiz auto en agenda quick: 4 s√©ries tir√©es et s√©rialis√©es dans `lot_ids` via le flux `session_theme`

## Update 2026-02-22 ‚Äî Ajustements post-recette agenda quick / quiz d√©tail
- Scope code:
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_list_bloc.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_list.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Actions r√©alis√©es:
  - agenda cards:
    - restauration du CTA d‚Äôacc√®s session avec garde-fou offre active conserv√© (`app_session_launch_guard_get`)
    - en cas de blocage, CTA pointe vers `cta_url` guard (commande/offres) avec libell√© guard
  - Quiz V2 d√©tail session:
    - suppression du CTA global ‚ÄúChanger la th√©matique‚Äù
    - affichage des s√©ries par d√©faut, ouverture d√©tail s√©rie par s√©rie
    - actions par s√©rie: `Voir le d√©tail` puis `Modifier`
    - drag-and-drop de l‚Äôordre des s√©ries avec sauvegarde automatique imm√©diate
  - biblioth√®que (modification de session):
    - bandeau jaune ‚ÄúModification de th√©matique‚Äù en haut de page (liste + fiche)
    - navigation de modification orient√©e vers la liste biblioth√®que filtr√©e (pas vers une fiche s√©rie sp√©cifique)
- V√©rifications:
  - `php -l` OK sur les fichiers PHP modifi√©s

## Update 2026-02-22 ‚Äî Documentation routing/flux + micro-fixs UX
- Scope doc:
  - `documentation/canon/repos/pro/README.md`
  - `documentation/canon/repos/pro/TASKS.md`
  - `documentation/canon/repos/pro/HANDOFF.md`
- Mises √† jour document√©es:
  - routes/flux start agenda quick confirm√©s dans README:
    - `start/agenda/mode/*`
    - `frm_mode=session_setting_multi`
    - r√©sum√© batch `start/game/resume-batch/{batch_token}`
  - quick quiz:
    - auto-th√®me sur 4 s√©ries
  - changement de th√©matique session existante:
    - entr√©e depuis fiche session
    - redirection vers liste biblioth√®que filtr√©e jeu
    - bandeau biblioth√®que contextualis√© par jeu (quiz/bingo/blindtest)
  - fiche session:
    - labels harmonis√©s `Modifier la playlist` / `Modifier cette s√©rie`
    - r√©ordonnancement Quiz V2: retour sur fiche d√©tail (pas r√©sum√©)

## Update 2026-02-22 ‚Äî Agenda fiche session -> VIEW biblioth√®que contextualis√©e
- Scope code:
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php`
- Actions r√©alis√©es:
  - fiche session agenda:
    - ajout/normalisation des liens `Voir le d√©tail` vers la VIEW biblioth√®que pour Quiz/Bingo/Blindtest
    - params standard transmis: `context=session`, `id_securite_session`, `return_to=session_view`, `item_type`, `item_id`
    - Bingo/Blindtest: `Voir le d√©tail` positionn√© √† gauche de `Modifier la playlist`
  - biblioth√®que VIEW:
    - support landing direct par `item_type + item_id` en contexte session
    - validation session (`id_securite_session`) c√¥t√© client connect√© avant activation du mode contextuel
    - bandeau haut dat√© par jeu:
      - `Playlist du Blindtest programm√© le jj/mm/aaaa`
      - `Playlist du Bingo Musical programm√© le jj/mm/aaaa`
      - `S√©rie du Quiz programm√© le jj/mm/aaaa`
    - CTA usage remplac√© par un bouton unique `Retour √† la session`
    - CTA d√©mo masqu√© en contexte session
    - lien `‚Üê Retour au catalogue` masqu√© en contexte session
    - log structur√© ajout√©: `LIB_VIEW_CONTEXT_SESSION`
- V√©rifications:
  - `php -l pro/web/ec/modules/tunnel/start/ec_start_sessions_view.php` OK
  - `php -l pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_view.php` OK
- TODO QA:
  - valider quick 1 date et N dates en conditions r√©elles
  - valider fallback anti-r√©p√©tition (365/180/30/0) avec historique dense
  - valider non-r√©gression compl√®te des flux start standard + biblioth√®que existants

## Update 2026-02-20 ‚Äî PATCH impl√©ment√© (schedule autoris√©, launch backend-gated)
- Scope code:
  - `pro/web/ec/ec.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_step_1_game.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_script.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_play_classic.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_sessions_list_bloc.php`
  - `global/web/app/modules/jeux/sessions/app_sessions_functions.php`
- Actions r√©alis√©es:
  - programmation:
    - suppression du renvoi e-commerce par d√©faut au moment de programmer (onboarding `choose/0`)
    - `session_init` accepte explicitement le mode non-d√©mo via `flag_session_demo=0` m√™me sans offre active
  - lancement:
    - ajout d‚Äôun garde-fou backend central `app_session_launch_guard_get(...)`
    - application du verdict en point d‚Äôentr√©e `/extranet/start/game/play/{id}` avec refus propre + CTA `Voir les offres`
  - uniformisation:
    - `app_session_get_link(..., 'launcher', ...)` passe d√©sormais par le funnel `/start/game/play/{id}` (backend source-of-truth)
    - garde-fou UI local retir√© de la carte agenda (la d√©cision d‚Äôacc√®s n‚Äôest plus c√¥t√© template)
- V√©rifications:
  - `php -l` OK sur tous les fichiers touch√©s

## Update 2026-02-20 ‚Äî Fix remaining entrypoints blocking scheduling
- Scope code:
  - `pro/web/ec/modules/widget/ec_widget_jeux_sessions_cta.php`
  - `pro/web/ec/modules/tunnel/start/ec_start_step_0_offres_client.php`
  - `pro/web/ec/modules/jeux/bibliotheque/ec_bibliotheque_script.php`
- Actions r√©alis√©es:
  - widget agenda vide:
    - CTA sans offre active redirig√© vers `/extranet/start/game/choose/0` (plus vers commande e-commerce)
  - route `/extranet/start/game/offres/`:
    - si aucune offre active list√©e, redirection automatique vers `choose/0` (programmation autoris√©e)
    - conservation du contexte √©ventuel (`id_securite_operation_evenement`, `from`)
  - biblioth√®que (programmation non-d√©mo):
    - suppression du retour forc√© `/start/game/offres/` quand pas d‚Äôoffre active
    - envoi explicite `flag_session_demo=0` dans `session_init`
- V√©rifications:
  - `php -l` OK sur les 3 fichiers

## Update 2026-02-20 ‚Äî Home EC sans offre active (widgets harmonis√©s)
- Scope code:
  - `pro/web/ec/modules/communication/home/ec_home_index.php`
  - `pro/web/ec/modules/widget/ec_widget_ecommerce_abonnement.php`
  - `pro/web/ec/modules/widget/ec_widget_jeux_discover_library.php`
- Actions r√©alis√©es:
  - home no-offer:
    - affichage forc√© de 2 widgets uniquement (commande puis d√©couverte biblioth√®que)
    - masquage des autres widgets de home dans ce cas
  - mapping commande no-offer:
    - typologie `1/8` (+ d√©faut) => widget abonnement
    - typologie `2/3` => widget √©v√©nement
    - typologie `12` => widget particulier
  - bypass r√®gles internes abonnement en no-offer:
    - plus de blocage par `id_pipeline_etat` / `id_solution_usage` si `offre_client_active_count==0`
  - widget biblioth√®que:
    - nouveau widget ‚ÄúD√©couvre les jeux Cotton‚Äù enrichi (3 points + pictos)
    - CTA vers `/extranet/games/library`
- V√©rifications:
  - `php -l` OK sur les fichiers touch√©s

## R√©sum√© audit
- Audit effectu√© sur les flux `start` (programmation + lancement) avec preuves `fichier:ligne`.
- Garde-fou actuel trouv√© principalement dans la carte agenda (UI) et non au point backend source-of-truth.
- Cartographie livr√©e pour:
  - flux `PROGRAMMER` (onboarding offres -> `session_init` -> write session)
  - flux `LANCER/JOUER` (UI cards/widgets -> `app_session_get_link` -> route play/launcher)
  - emplacement de la carte session programm√©e pour le futur message paywall + CTA offres.

## Points d‚Äôentr√©e cl√©s identifi√©s
- Routing start: `pro/web/.htaccess:168`, `pro/web/.htaccess:179`, `pro/web/.htaccess:200`
- Calcul onboarding offre active: `pro/web/ec/ec.php:63`, `pro/web/ec/ec.php:100`, `pro/web/ec/ec.php:119`
- Create session (`session_init`): `pro/web/ec/modules/tunnel/start/ec_start_script.php:161`, `pro/web/ec/modules/tunnel/start/ec_start_script.php:258`
- Garde-fou UI actuel (agenda): `pro/web/ec/modules/tunnel/start/ec_start_sessions_list_bloc.php:291`, `pro/web/ec/modules/tunnel/start/ec_start_sessions_list_bloc.php:536`
- G√©n√©ration des liens de lancement: `global/web/app/modules/jeux/sessions/app_sessions_functions.php:851`

## R√©f√©rence d√©taill√©e
- Voir `canon/repos/pro/sessions_scheduled_paywall_audit.md`.
