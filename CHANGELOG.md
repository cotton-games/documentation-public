# Changelog

> Keep it short: user-facing behavior + interfaces + migrations.

<!-- AUTO-UPDATE:BEGIN id="changelog-latest" owner="codex" -->
## Unreleased
- Pro EC (bibliothèque Quiz): le champ `Commentaire` reste facultatif, affiché en monoligne et positionné sous `Fausse proposition 1/2/3`, avec une aide inline `À l’attention du quiz master.`; les formulaires passent aussi à la ligne après `Bonne réponse`, la marge `mb-2` sous la note des fausses propositions est retirée, et l’espacement au-dessus des boutons est harmonisé en `mt-4`.
- Pro EC (bibliothèque Quiz): harmonisation des formulaires question: les champs `Fausse proposition 1/2/3` sont regroupés ensemble, et le bloc `Type support` + champs associés est repositionné en fin de formulaire (création/édition série perso, modif/remplacement lot temporaire).
- Pro EC (bibliothèque Quiz): le champ `Commentaire` est de nouveau disponible dans les formulaires de création/édition de questions (séries perso, remplacement de question en lot temporaire côté client, édition de question en lot temporaire côté admin).
- Pro EC (bibliothèque): `A la une` et le badge `En ce moment` passent en logique stricte “en cours” (date du jour entre `jour_associe_debut` et `jour_associe_fin`), sans fenêtre glissante “J-90”.
- Pro EC (bibliothèque): correctif édition meta admin sur contenu Cotton/Communauté: la sauvegarde n’écrase plus le partage communauté sur les contenus non-owner, évitant le passage involontaire de `community_items.status` en `hidden` et la disparition en liste.
- Pro EC (bibliothèque): le compte admin (`id_client=10`) peut désormais modifier/supprimer une thématique Cotton/Communauté même si elle est en cours d’utilisation; le bandeau d’information d’usage reste affiché en view, et le comportement non-admin est inchangé.
- Pro EC (bibliothèque Quiz, onglet admin `Lots temporaires`): correction du compteur `Jouée X fois` pour compter uniquement les occurrences `T{id}` (lots temporaires), sans mélange avec les usages des lots catalogue `L{id}`.
- Pro EC (bibliothèque list): le bloc de pagination est maintenant responsive sur mobile (scroll horizontal du pager), ce qui évite le débordement hors écran.
- Pro EC (bibliothèque): ajout d’une action admin `Certifier ce contenu` (onglet `Communauté`) pour promouvoir un contenu vers `Cotton` sans perdre l’auteur initial; le contenu bascule ensuite dans l’onglet `Cotton` pour tous les utilisateurs.
- Pro EC (bibliothèque): un contenu promu vers `Cotton` est désormais retiré de l’onglet `Communauté` (filtre SQL aligné sur `origin='cotton'`).
- Pro EC (bibliothèque Quiz): ajout d’un onglet admin-only `Lots temporaires` pour auditer/ouvrir les séries auto-générées quiz papier; correction des questions verrouillée admin-only (UI + backend).
- Pro EC (bibliothèque): le bypass admin (`id_client=10`) de modification/édition/suppression des thématiques est étendu aux contenus Cotton (`id_client_auteur=0`), en plus des contenus communauté.
- Pro EC (`/extranet/start/game/view`, sessions papier tous jeux): libellé des liens d’impression harmonisé en `Imprimer les feuilles de réponses` (URLs d’impression inchangées).
- Pro EC (fiche session agenda Blindtest/Bingo): bouton `Remplacer` playlist harmonisé en largeur compacte pour alignement visuel avec les autres actions de la page.
- Pro EC (fiche session agenda Quiz V2): correctif suppression de slot pour gérer les tokens `L` et `T` (lots temporaires). La suppression d’un lot temporaire ne provoque plus la suppression complète de la session.
- Pro EC (bibliothèque list `A la une`): ajout d’un badge `En ce moment` (même shape que `Populaire`, couleur dédiée) affiché uniquement sur les contenus Cotton réellement dans la période courante (logique date `jour_associe_debut/fin`).
- Pro EC (menu latéral INS/CSO): le lien `Mon agenda` est désormais visible pour INS+CHR même sans session programmée; le lien `Media Kit` est masqué pour INS/CSO particulier ou événement, sans changement pour CHR.
- Pro EC (`/extranet/start/agenda/mode`, quiz uniquement): textes des cartes ajustés (`4 séries de quiz populaires...`, titre carte 2 `Choisir mes thématiques`) sans impact bingo/blindtest.
- Pro EC (fiche session agenda): le bouton de remplacement est harmonisé en `Remplacer` (quiz et playlist). Pour les séries auto temporaires de quiz papier, le bouton `Remplacer` reste masqué mais la suppression de série est conservée; le lien devient `Voir / Modifier`.
- Pro EC (bibliothèque, fiche détail): le bouton audio `Écouter 10s` affiche désormais un état visuel explicite (`play` idle, `spinner` loading, `stop` playing avec libellé `Arrêter`), permet l’arrêt manuel, revient proprement à l’état initial en fin de preview/erreur, et garantit un seul aperçu audio actif à la fois.
- Pro EC (`/extranet/start/games`): la vue `Mon agenda` est désormais structurée par dates (sections datées + compteur, jalons en uppercase), renforce la hiérarchie date/heure dans chaque carte (ligne unique `DATE - HEURE`, gras, non-wrap), allège le poids du visuel, et met à jour le CTA secondaire carte en `Gérer` avec icône sliders (sans sous-texte de page).
- Pro EC (bibliothèque Quiz, lots temporaires `T{id}`): en mode admin bibliothèque (`Lots temporaires`), la fiche détail passe en maintenance “édition en place” des questions (icône `✎`, formulaire prérempli réutilisé, backend `content_library_temp_lot_question_update` admin-only). Le CTA principal devient `Lancer une démo` et la fiche conserve un affichage informatif des sessions liées.
- Pro EC (bibliothèque Quiz, lots temporaires `T{id}`): recadrage UX “catalogue admin” (et non agenda): suppression du framing session sur la view admin (`Série programmée...`, `Retour à la session`), bloc `Sessions liées` filtré hors démos (`flag_session_demo=0`), et affichage explicite des liens de supports existants dans la modale d’édition.
- Pro EC (agenda quick Quiz papier): correctif de régression sur l’auto-génération des lots: le flux revient à `T,T,T,L` (3 lots temporaires + 1 lot catalogue) en mode papier, au lieu de rester en `4xL`.
- Pro EC (quiz papier, lots temporaires liés à une session): restauration du flux de remplacement des questions pour les clients non-admin en contexte session agenda (bouton `↻` + modale remplacement A/B), tout en conservant le mode édition admin (`✎`) dans l’onglet maintenance `Lots temporaires`.
- Pro EC (lots temporaires quiz): correction du mapping `jour_associe` lors de création/remplacement et modification admin: la date UI `YYYY-MM-DD` est maintenant normalisée au format DB `MM-DD` (colonne `questions.jour_associe`), évitant la troncature (`2026-`) et les incohérences post-insert.
- Pro EC (lots temporaires quiz, modale admin): correction du préremplissage des propositions à la réouverture d’une question modifiée (rechargement depuis `questions_propositions` vers `proposition_1..4`).
- Pro EC (lots temporaires quiz, modale admin): le formulaire d’édition n’affiche plus de champ `proposition 4`, aligné avec le flux de remplacement (3 fausses propositions visibles).
- Pro EC (lots temporaires quiz, modale admin): le bloc `Support(s) actuel(s)` affiche désormais `Support question : {url cliquable}` pour rendre le lien courant immédiatement lisible.
- Pro EC (bibliothèque Quiz, onglet admin `Lots temporaires`): la liste est maintenant triée du plus récent au plus ancien selon la date de création des lots (`date_ajout` décroissante).
- Pro EC (bibliothèque Quiz, vue admin `Lots temporaires`): le badge de verrou d’usage (“en cours d’utilisation... / modification impossible”) n’est plus affiché pour les lots temporaires.
- Pro EC (bibliothèque Quiz, vue admin `Lots temporaires`): le CTA `Lancer une démo` crée désormais une session démo Quiz dédiée contenant uniquement le lot temporaire courant (`T{id}`), au lieu de dupliquer une session liée complète.
- Pro EC (bibliothèque): le badge `Populaire` n’est plus affiché sur l’onglet admin `Lots temporaires` (lots `T`) et reste réservé aux contenus catalogue (`L`) des onglets `Cotton` / `Communauté` / `Mes`.
- Pro EC (bibliothèque Quiz, filtre `A la une`): alignement avec les playlists sur la logique “thématiques du moment” (`jour_associe_debut/fin`) et affichage du badge `En ce moment` sur les séries Quiz concernées.
- Pro EC (bibliothèque Quiz, lots temporaires auto): la fiche détail affiche désormais un rendu simplifié (`<nom> (auto)`, sous-titre nettoyé, auteur `Cotton`, `Contenu: 6 questions`, `Durée indicative: 5 min`), utilise l’image par défaut de série si besoin, et ajoute `Date de référence: jj/mm/aaaa` pour `Cette semaine dans l'histoire` (date de session). Côté fiche session agenda, le badge `Auto` est retiré au profit du suffixe `(auto)` dans le nom.
- Pro EC (`/start/game/setting`): UI de programmation agenda quick ajustée: titre `Programmation rapide {jeu}` (sans icône), sous-titre simplifié, bloc paramètres élargi (`col-xl-12`), labels `Version du jeu`/`Programmation` en gras avec plus d’espace, `Récurrence` affichée en premier et active par défaut, jour de semaine auto-prérempli sur le jour courant.
- Pro EC (agenda quick/pivot): après un passage par `Choisir une thématique` qui purge la session pré-initialisée, un clic `Programmation rapide` recrée désormais automatiquement une session (même jeu) et ouvre directement `/start/game/setting?...from=agenda&mode=quick` (sans étape interactive intermédiaire de choix du jeu).
- Pro EC (bibliothèque, view Cotton/Communauté): ajout d’un bouton rouge `Signaler un problème sur cette playlist/série` dans le header du contenu, avec modale de motif (inapproprié/erreurs/autre, détail conditionnel) et envoi d’un signalement par mail à `contact@cotton-quiz.com`.
- Pro EC (bibliothèque list UX POC): remplacement des onglets source par un segmented control (`Cotton / Communauté / Perso`), ajout d’une barre compacte recherche/tri, ajout de quick chips (`Populaires / Nouveautés / Thèmes / Tous les filtres`) + chips `Perso` (`À compléter / Prêtes à jouer`), wiring URL (`source/preset/q/sort/perso_state`) avec persistance reload/share et états vides contextualisés.
- Pro EC (bibliothèque): `/extranet/games/library` devient un portail “Les jeux” (3 blocs Quiz/Bingo/Blindtest). La list est affichée via `?game=quiz|bingo|blindtest`, sans les 3 blocs jeu en haut, avec titre simplifié au nom du jeu et menu latéral renommé `Les jeux`.
- Pro EC (bibliothèque, fiche thématique): refonte UX du détail en page (métadonnées alignées liste, contenu questions/morceaux sans modale), mode builder Quiz disponible depuis la fiche, et aperçus supports multimédias courts (`Extrait 10s` audio/vidéo, miniature image avec compat Google Drive, fallback YouTube à `start=30s` sans paramètres).
- Pro EC (bibliothèque Quiz): clic “Programmer une session” propose un mode builder sur la liste (Ajouter/Retirer jusqu’à 4 séries en session), puis passage `step_2_setting`; la sélection est transportée via `quiz_lot_ids` et appliquée au tunnel start avec la logique existante `lot_ids` avant le résumé.
- Pro EC (bibliothèque): “Programmer une session” passe désormais par `step_2_setting` (date/format) avant le résumé avec conservation de la thématique (`from=library`), auto-`session_theme` après setting, garde tenant + validation catalogue; “Lancer une démo” conserve le flux existant sans `step_2_setting`.
- Quiz/Blindtest/Bingo WS observability: `WS_CLIENT_DISCONNECTED` enrichi avec `meta.ws_client_id`, `meta.ws_role` et `closeReason`, pour corréler plus finement les coupures socket avec les erreurs front de chargement support.
- Remote hydration hotfix (games): la sync organizer `initializeOrUpdateSession` renvoie désormais `playlistSongs` dès qu’une playlist non vide devient disponible (même après l’initialisation), ce qui rétablit l’hydratation remote (titre série, total questions, bouton support manuel).
- Player support-start hardening (games): timeout image/drive adaptatif (15s standard, 20s en connexion lente), retry unique avant erreur finale, annulation systématique des timers au `load/error`, et ajout du flag `stale_token` dans `SUPPORT_START_FAIL_DETAIL`.
- Pro EC (bibliothèque): itération UI/UX liste: sélecteur jeu visuel (cartes), accents couleur par jeu, onglet actif lisible selon jeu, filtre `Rubrique` déplacé sous onglets en auto-submit (rubriques limitées au contexte `jeu+onglet`), affichage difficulté type tunnel (3 icônes + libellé), actions directes carte (`Créer un jeu` / `Lancer une démo`) et lien détail contextualisé (`série`/`playlist`).
- Pro EC (bibliothèque): affichage enrichi des auteurs avec l’établissement auteur (`clients.nom`) en plus de `nom_auteur`, en liste et en fiche thématique.
- Pro EC (bibliothèque): images thématiques désormais affichées en liste et en fiche via les uploads existants (`cotton_quiz/questions_lots` pour Quiz, `bingo_musical/playlists` pour Bingo/Blind), avec fallback visuel quand aucune image n’est disponible.
- Pro EC: ajout d’un module MVP “Bibliotheque de contenus” (`/extranet/games/library`) avec sélection jeu (Quiz/Bingo/Blind), tabs (`Cotton/Communaute/Mes`), filtres rubrique + recherche + pagination, fiche thématique avec métas d’usage (`COUNT`/`MAX(date)` depuis `championnats_sessions`, cas CQv2 via `lot_ids`), et CTA “Programmer une session” / “Lancer une demo” auto-chaînés via le tunnel existant (`session_init` puis `session_theme`).
- Bingo phase winners canonical migration (games): `bingo_api_phase_winner` now resolves winner identity key-first (`player_id` canonique) before persistence; added `phase_winner_conflict` explicit error code; added support for canonical winner key storage/read via `bingo_phase_winners.player_id_key` (with legacy fallback), plus SQL ambiguity fix on joined conflict query (`w.session_id`, `w.phase`).
- Logs viewer chips fix (games): global level chips (`total/debug/info/warn/error`) now request forced stats recomputation (`stats=1&force=1`) to avoid stale cache mismatch after front flush (`visibles` unchanged and still client-side).
- Bingo waiting-state hotfix: changing organizer game options (e.g. `songDuration`) no longer clears player prizes/lots UI; front now sends `update_session_infos` only for paper/session-control fields, and Bingo WS no longer emits implicit empty `prizes` payloads when none are provided.
- Quiz/blindtest WS hotfix: fixed organizer disconnect crash (`ReferenceError: deactivations is not defined`) by restoring player deactivation promise collection in `disconnectPlayers`; session end now completes DB deactivate + socket cleanup without runtime error.
- Quiz/blindtest player reveal is now key-first: server emits `answerReveal` only after reveal timing/lock (wrong-answer players), carrying `{correctOption, correctOptionKey}`; player UI applies highlight by `data-option-key` with legacy text/index fallback.
- Quiz/blindtest security hotfix: `correctOptionKey` is now stripped from all player-bound WS payloads (`gameState/sessionUpdate/socket sends`) with a server-side guard log (`WS_PLAYER_PAYLOAD_STRIPPED`), while remote/organizer key-first reveal remains intact.
- Player answer compat migration: front now sends `selectedOptionKey` alongside `selectedOption`; server evaluates key-first when key is present with legacy fallback, and emits debug signals `PLAYER_ANSWER_RX` / `PLAYER_ANSWER_EVAL`.
- Remote quiz/blindtest: stabilize correct option reveal with key-first matching (`remote/options:correct` carries `{text,key}`, `sessionUpdate/gameState` propagate `correctOptionKey`, options carry stable `key`, and remote UI patches reveal via `data-option-key`), preventing blindtest/quiz reveal loss on text-format mismatches.
- BO “Jeux et joueurs” : drilldown sessions figé (table `reporting_games_sessions_detail` via cron, addition stricte joueurs) + modal filtrable (jeu/client) avec lien `logs_session.html`.
- Bingo `reset` migrated to Canvas API; WS no longer performs DB writes for reset.
- Removed DB log persistence from WS (no more `saveGameNotification` writes); logs remain file/stdout.
- Front clients updated to handle Canvas bridge envelope responses (`data` unwrapping).
- Organizer: hide customization/options buttons and QR/remote block for client `#1557`.
- Bingo WS/front: normalize `passed_song` counter key (`num_passed_songs`, legacy fallback `x`) + accept `registration_error` alias.
- Bingo demo reset: organizer calls Canvas API `resetdemo` then reloads; remote/player are resynced via WS `demo_reset` (no WS DB reset), and WS in-memory state is reset to neutral (`phase=0`, `num_passed_songs=0`, `is_playing=false`).
- Bingo: fix organizer WS `auth_client` payload (`id_playlist_client`) by propagating playlistId via DOM/preload/meta; prevent `session_update` from re-writing `morceau_courant` while `phase_courante=0` (avoids post-reset song_start races).
- Logs viewer/proxy (games): proxy simplifié (JSON stable `logs[]/meta`, tri asc, `session_id` normalisé, filtres min_level + recherche, stats raw/eff/invalid) ; viewer `logs_session.html` lit la nouvelle meta, affiche INFO/WARN/ERROR par défaut (DEBUG sur demande) et conserve l’export JSONL; action-map alignée (`loadingSupport`/`playerReady`→debug, `SUPPORT_START`→info, `WS_IN/WS_OUT`→debug, `JOIN_ERROR` warn).
- Logs viewer reset (games): `logs_session.html` réduit au minimum (session_id + min_level + charger, pas de pagination/recherche/flush/export), fetch unique page=1 limit=500, header explicite range_ts + pages_loaded/page_count + total + raw/eff/invalid; export désactivé.
<!-- AUTO-UPDATE:END id="changelog-latest" -->
