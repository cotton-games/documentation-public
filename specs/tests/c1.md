# Tests manuels — C1 (Bingo WS `song_start` → Canvas API `session_update`)

## Pré-requis
- WS Bingo démarré avec `CANVAS_API_URL` pointant vers `.../games_ajax.php?t=jeux&m=canvas` (alias: `.../global_ajax.php?t=jeux&m=canvas`)
- Token service en env (`CANVAS_SERVICE_TOKEN`) + Canvas configuré avec le même secret
- Une session de dev valide (sessionId/token)

## 1) Chemin nominal (API OK)
- Déclencher un `song_start` depuis l’orga.
- Vérifier dans les logs WS la présence de `msg="session_update via API ok"` avec `event_id` et `latencyMs`.
- Vérifier côté DB (Canvas) que:
  - `game_events` contient une ligne `game=bingo`, `action=session_update`, `event_id=<uuid>`
  - `jeux_bingo_musical_morceaux_to_playlists_clients` a bien le morceau (`id_morceau=id_song`) marqué (`flag_listening=1` + timestamp)

## 2) Idempotence (double-submit)
- Rejouer le même call Canvas API 2 fois avec le même `event_id` (cf. `specs/smoke-canvas-api.md`).
- Vérifier que le 2e call renvoie `already_processed=true`.

## 3) Erreur API (ne pas crasher le WS)
- Mettre temporairement `CANVAS_API_URL` sur une URL invalide puis déclencher `song_start`.
- Vérifier dans les logs WS la présence de `msg="session_update via API failed"` avec `event_id` (et le WS continue de tourner).

## Où regarder (WS)
- Fichier: `bingo.game/ws/bingo_server.js` (handler `case "song_start"`).
- Logs attendus: tag `LOG_TAGS.SongStart` et message `session_update via API ok/failed`.
